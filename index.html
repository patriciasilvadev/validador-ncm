<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de NCM (Frontend)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Vari√°veis CSS para Cores */
        :root {
            --primary-color: #007bff; /* Azul vibrante */
            --secondary-color: #0056b3; /* Azul mais escuro para hover */
            --background-light: #f9f9f9;
            --container-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            /* Cores ajustadas para maior clareza */
            --valid-bg: #d8fae7; /* Verde muito claro */
            --valid-text: #008000; /* Verde escuro */
            --invalid-bg: #fce2e2; /* Vermelho muito claro */
            --invalid-text: #cc0000; /* Vermelho escuro */
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 40px 20px;
            background-color: var(--background-light);
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--container-shadow);
        }

        h1 {
            color: var(--secondary-color);
            text-align: center;
            font-weight: 700;
            margin-bottom: 5px;
        }

        h2 {
            color: #444;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        /* Se√ß√£o de Input e Upload */
        .input-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            padding: 25px;
            border: 2px dashed #d1d9e6;
            border-radius: 8px;
            background-color: #fcfdff;
        }

        .input-section p {
            font-size: 1.1em;
            color: #555;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Estiliza√ß√£o para o bot√£o de Escolher Arquivo */
        #excelFile {
            display: none; /* Esconde o input original */
        }

        .custom-file-upload {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.3);
            display: inline-block;
            margin-right: 15px; /* Espa√ßo entre o label e o nome do arquivo */
        }

        .custom-file-upload:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 6px 8px rgba(0, 123, 255, 0.4);
        }

        .file-name {
            font-style: italic;
            color: #777;
            margin-left: 10px;
        }

        /* Bot√£o de Download */
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls button {
            background-color: #28a745; /* Verde para Download */
            color: white;
            margin-top: 30px;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.3);
        }

        .controls button:hover {
            background-color: #1e7e34;
        }

        /* Tabela de Resultados */
        #results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden; /* Garante que os cantos arredondados sejam respeitados */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        #results-table th, #results-table td {
            padding: 12px 15px;
            text-align: left;
            font-size: 0.9em;
        }

        #results-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* CORRE√á√ïES PARA APLICAR COR TOTAL E REMOVER ZEBRADO CINZA */
        
        /* 1. Remove o zebrado cinza para que o status pinte a linha inteira */
        #results-table tr:nth-child(even) {
            background-color: transparent !important; 
        }

        /* 2. Aplica a cor de fundo em TODAS as c√©lulas do status V√°lido */
        .status-valid {
            background-color: var(--valid-bg) !important; 
        }
        .status-valid td { 
            background-color: var(--valid-bg) !important; /* For√ßa o fundo em todos os TDs */
        }
        .status-valid td:nth-child(4) { 
             color: var(--valid-text) !important;
             font-weight: 600;
        }

        /* 3. Aplica a cor de fundo em TODAS as c√©lulas do status Inv√°lido */
        .status-invalid {
            background-color: var(--invalid-bg) !important;
        }
        .status-invalid td {
            background-color: var(--invalid-bg) !important; /* For√ßa o fundo em todos os TDs */
        }
        .status-invalid td:nth-child(4) { 
            color: var(--invalid-text) !important;
            font-weight: 600;
        }

        /* 4. Manter o hover for√ßando a cor em todos os TDs */
        #results-table tr:hover td {
            background-color: #eef3ff !important; /* Destaque ao passar o mouse */
        }
        
        .hidden { display: none; }
        
        /* Mensagens */
        #loading-message, #error-message {
            font-weight: 600;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
        }

        #loading-message {
            color: var(--primary-color);
            background-color: #e9f7ff;
        }

        #error-message {
            color: var(--invalid-text);
            background-color: var(--invalid-bg);
            border: 1px solid var(--invalid-text);
        }

        /* Estilo para Resumo */
        .summary-box {
            background-color: #f0f8ff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
        }

        .summary-box h3 {
            color: var(--secondary-color);
            margin-top: 0;
        }

        .summary-box p {
            margin: 10px 0;
            font-size: 1em;
            color: #333;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‚úÖ Validador de NCM</h1>
    <p style="text-align: center; color: #666;">Valida√ß√£o de NCMs via upload de Excel contra a tabela TIPI vigente.</p>

    <div class="input-section">
        <p>
            Selecione o arquivo Excel (.xlsx/.xls) e os NCMs ser√£o validados automaticamente.
        </p>

        
        <label for="excelFile" class="custom-file-upload">
            Escolher Arquivo
        </label>
        <span id="file-selected-name" class="file-name">Nenhum arquivo selecionado</span>
        
        <input type="file" id="excelFile" accept=".xlsx, .xls" required>

        <p id="loading-message" class="hidden">Carregando e Validando dados... Aguarde (pode levar alguns segundos).</p>
        <p id="error-message" class="hidden"></p>
    </div>

    <div class="controls hidden" id="control-buttons">
        <button onclick="downloadResults()">Baixar Resultados (Excel)</button>
    </div>

    <div id="summary-results" class="summary-box hidden">
    </div>
    
    <div id="results-view" class="hidden">
        <h2>üìä Resultados da Valida√ß√£o</h2>
        <table id="results-table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>NCM Original</th>
                    <th>NCM Limpo (8 D√≠gitos)</th>
                    <th>Status da Valida√ß√£o</th>
                    <th>Observa√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

</div>

<script>
    // Vari√°veis globais
    let NCM_MAP = null; // Mapeamento final, onde a chave √© o NCM de 8 d√≠gitos (ex: '84715010')
    let originalData = []; // Armazena os dados do Excel lido com a coluna de status adicionada
    const fileNameDisplay = document.getElementById('file-selected-name');
    const summaryResultsDiv = document.getElementById('summary-results'); // Novo elemento

    // Fun√ß√£o principal para carregar o arquivo JSON e criar o Mapa de Busca
    async function loadNCMTable() {
        try {
            document.getElementById('loading-message').textContent = 'Carregando Tabela NCM (3MB)...';
            document.getElementById('loading-message').classList.remove('hidden');

            const response = await fetch('ncm_tabela.json');
            
            if (!response.ok) {
                throw new Error('Falha ao carregar ncm_tabela.json. Verifique o nome do arquivo.');
            }

            const ncmEstrutura = await response.json();
            
            // --- L√ìGICA DE PROCESSAMENTO CORRIGIDA ---
            NCM_MAP = {}; 
            
            for (const key in ncmEstrutura) {
                if (key === 'Data_Ultima_Atualizacao_NCM') {
                    continue; 
                }
                
                const item = ncmEstrutura[key];
                
                for (const subKey in item) {
                    const subItem = item[subKey];
                    
                    if (subItem && subItem.Codigo) {
                        const ncmFinal = String(subItem.Codigo).replace(/[^0-9]/g, '');
                        
                        if (ncmFinal.length === 8) { 
                           NCM_MAP[ncmFinal] = subItem;
                        }
                    }
                }
            }
            // ------------------------------------

            if (Object.keys(NCM_MAP).length === 0) {
                throw new Error('Nenhum c√≥digo NCM v√°lido foi extra√≠do da tabela JSON.');
            }

            document.getElementById('loading-message').textContent = `Tabela NCM carregada: ${Object.keys(NCM_MAP).length} c√≥digos prontos.`;
        } catch (error) {
            console.error("Erro ao carregar a tabela NCM:", error);
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = 'ERRO CR√çTICO: N√£o foi poss√≠vel carregar ou processar a tabela NCM. (' + error.message + ')';
            errorElement.classList.remove('hidden');
            document.getElementById('loading-message').classList.add('hidden');
        }
    }

    // Inicializa o carregamento da tabela NCM ao carregar a p√°gina
    window.onload = loadNCMTable; 

    // Listener para o upload do arquivo Excel
    document.getElementById('excelFile').addEventListener('change', handleFile, false); 

    // --- FUN√á√ÉO PARA LER O ARQUIVO EXCEL ---
    function handleFile(e) {
        if (!NCM_MAP) {
            alert("Aguarde, a tabela NCM ainda est√° sendo carregada.");
            e.target.value = null; // Limpa a sele√ß√£o
            fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
            return;
        }

        const files = e.target.files;
        if (files.length === 0) {
            fileNameDisplay.textContent = 'Nenhum arquivo selecionado';
            return;
        }

        // Exibe o nome do arquivo selecionado
        const file = files[0];
        fileNameDisplay.textContent = file.name;

        // Limpa e exibe mensagem de carregamento/processamento
        document.getElementById('loading-message').textContent = 'Lendo e Validando o Excel...';
        document.getElementById('loading-message').classList.remove('hidden');
        document.getElementById('error-message').classList.add('hidden');
        document.getElementById('control-buttons').classList.add('hidden');
        document.getElementById('results-view').classList.add('hidden');
        if (summaryResultsDiv) summaryResultsDiv.classList.add('hidden'); // Oculta resumo anterior
        
        const reader = new FileReader();

        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Converte a planilha para um array de arrays de dados
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                processData(json);

                document.getElementById('loading-message').classList.add('hidden');
                document.getElementById('control-buttons').classList.remove('hidden');
                document.getElementById('results-view').classList.remove('hidden');
            } catch (err) {
                console.error("Erro ao ler o arquivo Excel:", err);
                document.getElementById('error-message').textContent = 'Erro ao processar o arquivo Excel. Verifique o formato.';
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('loading-message').classList.add('hidden');
            }
        };

        reader.onerror = function(error) {
             document.getElementById('error-message').textContent = 'Erro na leitura do arquivo: ' + error.message;
             document.getElementById('error-message').classList.remove('hidden');
             document.getElementById('loading-message').classList.add('hidden');
        };

        reader.readAsArrayBuffer(file);
    }

    // --- FUN√á√ÉO PARA PROCESSAR E VALIDAR OS DADOS (Com Zeros √† Esquerda) ---
    function processData(data) {
        // Assume que a primeira linha (√≠ndice 0) √© o cabe√ßalho
        const headers = data[0];
        
        // Fun√ß√£o auxiliar para encontrar √≠ndice de coluna com palavras-chave
        function findColumnIndex(headerArray, keywords) {
            return headerArray.findIndex(h => {
                if (!h) return false;
                const headerUpper = String(h).toUpperCase().trim();
                return keywords.some(keyword => headerUpper.includes(keyword));
            });
        }

        // Tentativa de detectar as colunas de NCM, PRODUTO e DESCRI√á√ÉO
        const ncmColIndex = findColumnIndex(headers, ['NCM']);
        const produtoColIndex = findColumnIndex(headers, ['PRODUTO', 'DESCRI√á√ÉO', 'DESCRICAO', 'DESC', 'NOME']);
        const descricaoColIndex = findColumnIndex(headers, ['DESCRI√á√ÉO', 'DESCRICAO', 'DESC']);

        if (ncmColIndex === -1) {
            alert("N√£o foi poss√≠vel encontrar a coluna 'NCM' no Excel. Certifique-se de que o cabe√ßalho est√° claro.");
            document.getElementById('control-buttons').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            return;
        }

        if (produtoColIndex === -1 && descricaoColIndex === -1) {
            alert("N√£o foi poss√≠vel encontrar as colunas 'Produto' ou 'Descri√ß√£o' no Excel. Certifique-se de que o cabe√ßalho est√° claro.");
            document.getElementById('control-buttons').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            return;
        }

        originalData = [];
        const resultsBody = document.querySelector('#results-table tbody');
        resultsBody.innerHTML = ''; // Limpa resultados anteriores

        // Processa as linhas de dados (a partir do √≠ndice 1, ap√≥s o cabe√ßalho)
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const originalNCM = String(row[ncmColIndex] || '').trim();
            
            // Prioriza coluna de Produto, mas usa Descri√ß√£o como fallback
            let originalProduto = 'N/A';
            if (produtoColIndex !== -1) {
                originalProduto = String(row[produtoColIndex] || '').trim();
            }
            if ((originalProduto === '' || originalProduto === 'N/A') && descricaoColIndex !== -1) {
                originalProduto = String(row[descricaoColIndex] || '').trim();
            }
            
            // Limpa o NCM para valida√ß√£o (remove pontos, tra√ßos, espa√ßos)
            let ncmLimpo = originalNCM.replace(/[^0-9]/g, '');

            // AJUSTE: Completa com zeros √† esquerda at√© 8 d√≠gitos (se tiver entre 1 e 7 d√≠gitos)
            if (ncmLimpo.length > 0 && ncmLimpo.length < 8) {
                ncmLimpo = ncmLimpo.padStart(8, '0');
            }
            
            let status, observacao;

            // 1. Valida√ß√£o de Formato (8 d√≠gitos num√©ricos)
            if (ncmLimpo.length !== 8 || !/^\d{8}$/.test(ncmLimpo)) {
                status = 'Inv√°lido';
                // A observa√ß√£o √© mais espec√≠fica ap√≥s a tentativa de preenchimento
                if (originalNCM === '') {
                    observacao = 'NCM em branco ou n√£o detectado.';
                } else if (ncmLimpo.length > 8) {
                    observacao = 'NCM excede 8 d√≠gitos ap√≥s a limpeza.';
                } else {
                    observacao = 'Formato inv√°lido. NCM deve ter 8 d√≠gitos num√©ricos.';
                }
            } 
            // 2. Valida√ß√£o de Exist√™ncia (Consulta ao MAPA NCM)
            else if (NCM_MAP.hasOwnProperty(ncmLimpo)) {
                status = 'V√°lido';
                // Adiciona a descri√ß√£o completa para o download
                observacao = 'NCM encontrado: ' + NCM_MAP[ncmLimpo].Descricao; 
            } 
            // 3. Inv√°lido (N√£o Encontrado)
            else {
                status = 'Inv√°lido';
                observacao = 'NCM n√£o encontrado na tabela vigente (TIPI).';
            }

            // Armazena para download
            const resultRow = {
                Produto: originalProduto,
                'NCM Original': originalNCM,
                'NCM Limpo (8 D√≠gitos)': ncmLimpo,
                'Status da Valida√ß√£o': status,
                Observa√ß√£o: observacao
            };
            originalData.push(resultRow);

            // Cria a linha na tabela de visualiza√ß√£o
            const tr = resultsBody.insertRow();
            // A classe √© aplicada na linha para estilizar todos os TDs
            tr.classList.add(status === 'V√°lido' ? 'status-valid' : 'status-invalid'); 

            tr.insertCell().textContent = resultRow.Produto;
            tr.insertCell().textContent = resultRow['NCM Original'];
            tr.insertCell().textContent = resultRow['NCM Limpo (8 D√≠gitos)'];
            tr.insertCell().textContent = resultRow['Status da Valida√ß√£o'];
            tr.insertCell().textContent = observacao.substring(0, 100) + (observacao.length > 100 ? '...' : ''); 
        }

        // Chama a fun√ß√£o de resumo ap√≥s processar todos os dados
        updateSummary();
    }

    // --- FUN√á√ÉO PARA ATUALIZAR O RESUMO E ESTAT√çSTICAS ---
    function updateSummary() {
        // Garante que o elemento existe e h√° dados para processar
        if (!summaryResultsDiv || originalData.length === 0) {
            if (summaryResultsDiv) summaryResultsDiv.classList.add('hidden');
            return;
        }
        
        const totalProducts = originalData.length;

        // Filtra e conta os NCMs Inv√°lidos
        const invalidProducts = originalData.filter(row => row['Status da Valida√ß√£o'] === 'Inv√°lido').length;

        // Calcula os NCMs V√°lidos
        const validProducts = totalProducts - invalidProducts;

        // Gera o conte√∫do HTML do resumo
        summaryResultsDiv.innerHTML = `
            <h3>üìà Estat√≠sticas da Valida√ß√£o</h3>
            <p>‚úÖ <strong>Total de Produtos V√°lidos:</strong> ${validProducts}</p>
            <p>‚ùå <strong>Total de Produtos Inv√°lidos:</strong> ${invalidProducts}</p>
            <p>üì¶ <strong>Total Geral de Produtos:</strong> ${totalProducts}</p>
        `;
        
        // Exibe o bloco de resumo
        summaryResultsDiv.classList.remove('hidden');
    }

    // --- FUN√á√ÉO PARA BAIXAR O ARQUIVO EXCEL ---
    function downloadResults() {
        if (originalData.length === 0) {
            alert('Nenhum dado processado para baixar.');
            return;
        }
        
        const worksheet = XLSX.utils.json_to_sheet(originalData);
        const workbook = XLSX.utils.book_new();
        
        XLSX.utils.book_append_sheet(workbook, worksheet, "Resultados NCM");
        
        XLSX.writeFile(workbook, "Resultados_Validacao_NCM.xlsx");
    }

</script>
<!--
Download da Tabela NCM em arquivo.json

https://www.gov.br/receitafederal/pt-br/assuntos/aduana-e-comercio-exterior/classificacao-fiscal-de-mercadorias/download-ncm-nomenclatura-comum-do-mercosul

-->
</body>
</html>